<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo Financeiro - ERP Pessoal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin: 0.25rem 0;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem 1rem 0 0 !important;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .progress {
            height: 0.5rem;
            border-radius: 0.25rem;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .finance-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .finance-card.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .finance-card.warning {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .finance-card.info {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3">
                    <h4 class="text-white mb-4">
                        <i class="fas fa-wallet me-2"></i>
                        Financeiro
                    </h4>
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            Dashboard
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('contas-pagar')">
                            <i class="fas fa-credit-card me-2"></i>
                            Contas a Pagar
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('contas-receber')">
                            <i class="fas fa-money-bill-wave me-2"></i>
                            Contas a Receber
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('metas')">
                            <i class="fas fa-bullseye me-2"></i>
                            Metas Financeiras
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('metas-mensais')">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Metas Mensais
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('investimentos')">
                            <i class="fas fa-chart-line me-2"></i>
                            Investimentos
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('relatorios')">
                            <i class="fas fa-chart-bar me-2"></i>
                            Relatórios
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="mb-0"><i class="fas fa-wallet me-2"></i>Módulo Financeiro</h2>
                    <div class="d-flex align-items-center gap-3">
                        <!-- Seletor de Mês -->
                        <div class="btn-group">
                            <button class="btn btn-outline-primary" onclick="alterarMes(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-primary" id="mes-atual-display">
                                <i class="fas fa-calendar me-2"></i>
                                <span id="mes-nome">Dezembro 2024</span>
                            </button>
                            <button class="btn btn-outline-primary" onclick="alterarMes(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <a href="/dashboard" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Voltar para a Principal
                        </a>
                    </div>
                </div>
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="content-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard Financeiro</h2>
                        <div class="d-flex align-items-center gap-3">
                            <!-- Seletor de Modo do Dashboard -->
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="dashboard-mode" id="dashboard-mensal" value="mensal" checked>
                                <label class="btn btn-outline-primary" for="dashboard-mensal">
                                    <i class="fas fa-calendar-day me-1"></i>Mensal
                                </label>
                                
                                <input type="radio" class="btn-check" name="dashboard-mode" id="dashboard-anual" value="anual">
                                <label class="btn btn-outline-primary" for="dashboard-anual">
                                    <i class="fas fa-calendar-alt me-1"></i>Anual
                                </label>
                                
                                <input type="radio" class="btn-check" name="dashboard-mode" id="dashboard-total" value="total">
                                <label class="btn btn-outline-primary" for="dashboard-total">
                                    <i class="fas fa-chart-line me-1"></i>Total
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="loadDashboard()">
                                <i class="fas fa-sync-alt me-2"></i>Atualizar
                            </button>
                        </div>
                    </div>

                    <!-- Cards de Resumo -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card finance-card">
                                <div class="card-body text-center">
                                    <i class="fas fa-wallet fa-2x mb-2"></i>
                                    <h5 id="saldo-label">Saldo do Mês</h5>
                                    <h3 id="saldo-atual">R$ 0,00</h3>
                                    <small class="text-muted" id="saldo-periodo">Outubro 2024</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card finance-card success">
                                <div class="card-body text-center">
                                    <i class="fas fa-arrow-up fa-2x mb-2"></i>
                                    <h5 id="receitas-label">Receitas</h5>
                                    <h3 id="receitas-mes">R$ 0,00</h3>
                                    <small class="text-muted" id="receitas-periodo">Outubro 2024</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card finance-card warning">
                                <div class="card-body text-center">
                                    <i class="fas fa-arrow-down fa-2x mb-2"></i>
                                    <h5 id="despesas-label">Despesas</h5>
                                    <h3 id="despesas-mes">R$ 0,00</h3>
                                    <small class="text-muted" id="despesas-periodo">Outubro 2024</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card finance-card info">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                                    <h5 id="investimentos-label">Investimentos</h5>
                                    <h3 id="total-investido">R$ 0,00</h3>
                                    <small class="text-muted" id="investimentos-periodo">Outubro 2024</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gráfico e Próximas Contas -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-area me-2"></i>Evolução Financeira (12 meses)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="graficoEvolucao"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-clock me-2"></i>Próximas Contas</h5>
                                </div>
                                <div class="card-body">
                                    <div id="proximas-contas">
                                        <p class="text-muted">Carregando...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contas a Pagar Section -->
                <div id="contas-pagar-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-credit-card me-2"></i>Contas a Pagar</h2>
                        <div>
                            <button class="btn btn-primary me-2" onclick="showModal('modalContaPagar')">
                                <i class="fas fa-plus me-2"></i>Nova Conta
                            </button>
                            <button class="btn btn-success" onclick="showModal('modalContaParcelada')">
                                <i class="fas fa-calendar-alt me-2"></i>Conta Parcelada
                            </button>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="filtro-status-pagar">
                                        <option value="">Todos</option>
                                        <option value="pendente">Pendente</option>
                                        <option value="pago">Pago</option>
                                        <option value="vencido">Vencido</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Categoria</label>
                                    <select class="form-select" id="filtro-categoria-pagar">
                                        <option value="">Todas</option>
                                        <option value="alimentacao">Alimentação</option>
                                        <option value="transporte">Transporte</option>
                                        <option value="moradia">Moradia</option>
                                        <option value="saude">Saúde</option>
                                        <option value="educacao">Educação</option>
                                        <option value="lazer">Lazer</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Mês</label>
                                    <select class="form-select" id="filtro-mes-pagar">
                                        <option value="">Todos</option>
                                        <option value="1">Janeiro</option>
                                        <option value="2">Fevereiro</option>
                                        <option value="3">Março</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Maio</option>
                                        <option value="6">Junho</option>
                                        <option value="7">Julho</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Setembro</option>
                                        <option value="10">Outubro</option>
                                        <option value="11">Novembro</option>
                                        <option value="12">Dezembro</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-outline-primary w-100" onclick="filtrarContasPagar()">
                                        <i class="fas fa-filter me-2"></i>Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Contas -->
                    <div class="card">
                        <div class="card-body">
                            <div id="lista-contas-pagar">
                                <p class="text-muted">Carregando contas...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contas a Receber Section -->
                <div id="contas-receber-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-money-bill-wave me-2"></i>Contas a Receber</h2>
                        <button class="btn btn-primary" onclick="showModal('modalContaReceber')">
                            <i class="fas fa-plus me-2"></i>Nova Conta
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="filtro-status-receber">
                                        <option value="">Todos</option>
                                        <option value="pendente">Pendente</option>
                                        <option value="pago">Recebido</option>
                                        <option value="vencido">Vencido</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Categoria</label>
                                    <select class="form-select" id="filtro-categoria-receber">
                                        <option value="">Todas</option>
                                        <option value="alimentacao">Alimentação</option>
                                        <option value="transporte">Transporte</option>
                                        <option value="moradia">Moradia</option>
                                        <option value="saude">Saúde</option>
                                        <option value="educacao">Educação</option>
                                        <option value="lazer">Lazer</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Mês</label>
                                    <select class="form-select" id="filtro-mes-receber">
                                        <option value="">Todos</option>
                                        <option value="1">Janeiro</option>
                                        <option value="2">Fevereiro</option>
                                        <option value="3">Março</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Maio</option>
                                        <option value="6">Junho</option>
                                        <option value="7">Julho</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Setembro</option>
                                        <option value="10">Outubro</option>
                                        <option value="11">Novembro</option>
                                        <option value="12">Dezembro</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button class="btn btn-outline-primary w-100" onclick="filtrarContasReceber()">
                                        <i class="fas fa-filter me-2"></i>Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Contas -->
                    <div class="card">
                        <div class="card-body">
                            <div id="lista-contas-receber">
                                <p class="text-muted">Carregando contas...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metas Financeiras Section -->
                <div id="metas-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-bullseye me-2"></i>Metas Financeiras</h2>
                        <button class="btn btn-primary" onclick="showModal('modalMeta')">
                            <i class="fas fa-plus me-2"></i>Nova Meta
                        </button>
                    </div>

                    <!-- Cards de Metas -->
                    <div id="lista-metas" class="row">
                        <p class="text-muted">Carregando metas...</p>
                    </div>
                </div>

                <!-- Investimentos Section -->
                <div id="investimentos-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-chart-line me-2"></i>Investimentos</h2>
                        <button class="btn btn-primary" onclick="showModal('modalInvestimento')">
                            <i class="fas fa-plus me-2"></i>Novo Investimento
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Tipo</label>
                                    <select class="form-select" id="filtro-tipo-investimento">
                                        <option value="">Todos</option>
                                        <option value="poupanca">Poupança</option>
                                        <option value="cdb">CDB</option>
                                        <option value="lci">LCI</option>
                                        <option value="lca">LCA</option>
                                        <option value="fundos">Fundos</option>
                                        <option value="acoes">Ações</option>
                                        <option value="cripto">Cripto</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="filtro-status-investimento">
                                        <option value="">Todos</option>
                                        <option value="true">Ativo</option>
                                        <option value="false">Inativo</option>
                                    </select>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button class="btn btn-outline-primary w-100" onclick="filtrarInvestimentos()">
                                        <i class="fas fa-filter me-2"></i>Filtrar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Investimentos -->
                    <div class="card">
                        <div class="card-body">
                            <div id="lista-investimentos">
                                <p class="text-muted">Carregando investimentos...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metas Mensais Section -->
                <div id="metas-mensais-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-calendar-alt me-2"></i>Metas Mensais</h2>
                        <button class="btn btn-primary" onclick="criarMetaMensal()">
                            <i class="fas fa-plus me-2"></i>Nova Meta Mensal
                        </button>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-target me-2"></i>Status das Metas do Mês</h5>
                                </div>
                                <div class="card-body">
                                    <div id="status-metas-mensais">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span><i class="fas fa-arrow-up text-success me-2"></i>Receitas</span>
                                                    <span id="percentual-receita-mensal">0%</span>
                                                </div>
                                                <div class="progress mb-3">
                                                    <div class="progress-bar bg-success" id="barra-receita-mensal" style="width: 0%"></div>
                                                </div>
                                                <small class="text-muted" id="valor-receita-mensal">R$ 0,00 / R$ 0,00</small>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span><i class="fas fa-arrow-down text-danger me-2"></i>Despesas</span>
                                                    <span id="percentual-despesa-mensal">0%</span>
                                                </div>
                                                <div class="progress mb-3">
                                                    <div class="progress-bar bg-danger" id="barra-despesa-mensal" style="width: 0%"></div>
                                                </div>
                                                <small class="text-muted" id="valor-despesa-mensal">R$ 0,00 / R$ 0,00</small>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span><i class="fas fa-chart-line text-info me-2"></i>Investimentos</span>
                                                    <span id="percentual-investimento-mensal">0%</span>
                                                </div>
                                                <div class="progress mb-3">
                                                    <div class="progress-bar bg-info" id="barra-investimento-mensal" style="width: 0%"></div>
                                                </div>
                                                <small class="text-muted" id="valor-investimento-mensal">R$ 0,00 / R$ 0,00</small>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span><i class="fas fa-piggy-bank text-warning me-2"></i>Poupança</span>
                                                    <span id="percentual-poupanca-mensal">0%</span>
                                                </div>
                                                <div class="progress mb-3">
                                                    <div class="progress-bar bg-warning" id="barra-poupanca-mensal" style="width: 0%"></div>
                                                </div>
                                                <small class="text-muted" id="valor-poupanca-mensal">R$ 0,00 / R$ 0,00</small>
                                            </div>
                                        </div>
                                        <div class="mt-3 text-center">
                                            <span class="badge bg-secondary" id="status-geral-mensal">Status: Regular</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-list me-2"></i>Histórico de Metas Mensais</h5>
                                </div>
                                <div class="card-body">
                                    <div id="lista-metas-mensais">
                                        <p class="text-muted">Carregando metas mensais...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Relatórios Section -->
                <div id="relatorios-section" class="content-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-chart-bar me-2"></i>Relatórios</h2>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-pie-chart me-2"></i>Despesas por Categoria</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="graficoCategorias"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie me-2"></i>Receitas por Categoria</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="graficoReceitas"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Modal Conta a Pagar -->
    <div class="modal fade" id="modalContaPagar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nova Conta a Pagar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formContaPagar">
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="descricaoPagar" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor</label>
                            <input type="text" class="form-control" id="valorPagar" placeholder="R$ 0,00" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data de Vencimento</label>
                            <input type="date" class="form-control" id="vencimentoPagar" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" id="categoriaPagar" required>
                                <option value="alimentacao">Alimentação</option>
                                <option value="transporte">Transporte</option>
                                <option value="moradia">Moradia</option>
                                <option value="saude">Saúde</option>
                                <option value="educacao">Educação</option>
                                <option value="lazer">Lazer</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoesPagar" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarContaPagar()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Conta a Receber -->
    <div class="modal fade" id="modalContaReceber" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nova Conta a Receber</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formContaReceber">
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="descricaoReceber" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor</label>
                            <input type="text" class="form-control" id="valorReceber" placeholder="R$ 0,00" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data de Vencimento</label>
                            <input type="date" class="form-control" id="vencimentoReceber" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" id="categoriaReceber" required>
                                <option value="alimentacao">Alimentação</option>
                                <option value="transporte">Transporte</option>
                                <option value="moradia">Moradia</option>
                                <option value="saude">Saúde</option>
                                <option value="educacao">Educação</option>
                                <option value="lazer">Lazer</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoesReceber" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarContaReceber()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Conta Parcelada -->
    <div class="modal fade" id="modalContaParcelada" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nova Conta Parcelada</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formContaParcelada">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Descrição</label>
                                    <input type="text" class="form-control" id="descricaoParcelada" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Categoria</label>
                                    <select class="form-select" id="categoriaParcelada" required>
                                        <option value="alimentacao">Alimentação</option>
                                        <option value="transporte">Transporte</option>
                                        <option value="moradia">Moradia</option>
                                        <option value="saude">Saúde</option>
                                        <option value="educacao">Educação</option>
                                        <option value="lazer">Lazer</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Valor Total</label>
                                    <input type="text" class="form-control" id="valorTotalParcelada" placeholder="R$ 0,00" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Número de Parcelas</label>
                                    <input type="number" class="form-control" id="totalParcelas" min="2" max="60" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Valor da Parcela</label>
                                    <input type="text" class="form-control" id="valorParcelaCalculado" placeholder="R$ 0,00" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Data da Primeira Parcela</label>
                                    <input type="date" class="form-control" id="dataPrimeiraParcela" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Observações</label>
                                    <textarea class="form-control" id="observacoesParcelada" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Prévia das Parcelas:</strong>
                            <div id="previaParcelas" class="mt-2"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="salvarContaParcelada()">Criar Parcelas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Meta Financeira -->
    <div class="modal fade" id="modalMeta" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nova Meta Financeira</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formMeta">
                        <div class="mb-3">
                            <label class="form-label">Título</label>
                            <input type="text" class="form-control" id="tituloMeta" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <textarea class="form-control" id="descricaoMeta" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor da Meta</label>
                            <input type="text" class="form-control" id="valorMeta" placeholder="R$ 0,00" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Data de Início</label>
                                    <input type="date" class="form-control" id="inicioMeta" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Data da Meta</label>
                                    <input type="date" class="form-control" id="dataMeta" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cor</label>
                            <input type="color" class="form-control form-control-color" id="corMeta" value="#3B82F6">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarMeta()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Investimento -->
    <div class="modal fade" id="modalInvestimento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Novo Investimento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formInvestimento">
                        <div class="mb-3">
                            <label class="form-label">Nome</label>
                            <input type="text" class="form-control" id="nomeInvestimento" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" id="tipoInvestimento" required>
                                <option value="poupanca">Poupança</option>
                                <option value="cdb">CDB</option>
                                <option value="lci">LCI</option>
                                <option value="lca">LCA</option>
                                <option value="fundos">Fundos</option>
                                <option value="acoes">Ações</option>
                                <option value="cripto">Cripto</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Valor Investido</label>
                                    <input type="text" class="form-control" id="valorInvestido" placeholder="R$ 0,00" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Valor Atual</label>
                                    <input type="text" class="form-control" id="valorAtual" placeholder="R$ 0,00" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data do Investimento</label>
                            <input type="date" class="form-control" id="dataInvestimento" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rentabilidade Anual (%)</label>
                            <input type="number" class="form-control" id="rentabilidadeAnual" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoesInvestimento" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarInvestimento()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Conta a Pagar -->
    <div class="modal fade" id="modalEditarContaPagar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Conta a Pagar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarContaPagar">
                        <input type="hidden" id="editarContaPagarId">
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="editarDescricaoPagar" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor</label>
                            <input type="text" class="form-control" id="editarValorPagar" placeholder="R$ 0,00" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data de Vencimento</label>
                            <input type="date" class="form-control" id="editarVencimentoPagar" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" id="editarCategoriaPagar" required>
                                <option value="alimentacao">Alimentação</option>
                                <option value="transporte">Transporte</option>
                                <option value="moradia">Moradia</option>
                                <option value="saude">Saúde</option>
                                <option value="educacao">Educação</option>
                                <option value="lazer">Lazer</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editarStatusPagar" required>
                                <option value="pendente">Pendente</option>
                                <option value="pago">Pago</option>
                                <option value="vencido">Vencido</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="editarObservacoesPagar" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoContaPagar()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Conta a Receber -->
    <div class="modal fade" id="modalEditarContaReceber" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Conta a Receber</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarContaReceber">
                        <input type="hidden" id="editarContaReceberId">
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="editarDescricaoReceber" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor</label>
                            <input type="text" class="form-control" id="editarValorReceber" placeholder="R$ 0,00" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data de Vencimento</label>
                            <input type="date" class="form-control" id="editarVencimentoReceber" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <select class="form-select" id="editarCategoriaReceber" required>
                                <option value="alimentacao">Alimentação</option>
                                <option value="transporte">Transporte</option>
                                <option value="moradia">Moradia</option>
                                <option value="saude">Saúde</option>
                                <option value="educacao">Educação</option>
                                <option value="lazer">Lazer</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editarStatusReceber" required>
                                <option value="pendente">Pendente</option>
                                <option value="pago">Recebido</option>
                                <option value="vencido">Vencido</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="editarObservacoesReceber" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoContaReceber()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Meta -->
    <div class="modal fade" id="modalEditarMeta" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Meta Financeira</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarMeta">
                        <input type="hidden" id="editarMetaId">
                        <div class="mb-3">
                            <label class="form-label">Título</label>
                            <input type="text" class="form-control" id="editarTituloMeta" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <textarea class="form-control" id="editarDescricaoMeta" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Valor da Meta</label>
                            <input type="text" class="form-control" id="editarValorMeta" placeholder="R$ 0,00" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Data de Início</label>
                                    <input type="date" class="form-control" id="editarInicioMeta" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Data da Meta</label>
                                    <input type="date" class="form-control" id="editarDataMeta" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editarStatusMeta" required>
                                <option value="ativa">Ativa</option>
                                <option value="pausada">Pausada</option>
                                <option value="concluida">Concluída</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cor</label>
                            <input type="color" class="form-control form-control-color" id="editarCorMeta" value="#3B82F6">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoMeta()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Investimento -->
    <div class="modal fade" id="modalEditarInvestimento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Investimento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarInvestimento">
                        <input type="hidden" id="editarInvestimentoId">
                        <div class="mb-3">
                            <label class="form-label">Nome</label>
                            <input type="text" class="form-control" id="editarNomeInvestimento" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" id="editarTipoInvestimento" required>
                                <option value="poupanca">Poupança</option>
                                <option value="cdb">CDB</option>
                                <option value="lci">LCI</option>
                                <option value="lca">LCA</option>
                                <option value="fundos">Fundos</option>
                                <option value="acoes">Ações</option>
                                <option value="cripto">Cripto</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Valor Investido</label>
                                    <input type="text" class="form-control" id="editarValorInvestido" placeholder="R$ 0,00" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Valor Atual</label>
                                    <input type="text" class="form-control" id="editarValorAtual" placeholder="R$ 0,00" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data do Investimento</label>
                            <input type="date" class="form-control" id="editarDataInvestimento" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rentabilidade Anual (%)</label>
                            <input type="number" class="form-control" id="editarRentabilidadeAnual" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editarAtivoInvestimento" required>
                                <option value="true">Ativo</option>
                                <option value="false">Inativo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Observações</label>
                            <textarea class="form-control" id="editarObservacoesInvestimento" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoInvestimento()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Transação de Meta -->
    <div class="modal fade" id="modalTransacaoMeta" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Valor à Meta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formTransacaoMeta">
                        <input type="hidden" id="metaIdTransacao">
                        <div class="mb-3">
                            <label class="form-label">Valor</label>
                            <input type="text" class="form-control" id="valorTransacao" placeholder="R$ 0,00" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="descricaoTransacao">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data da Transação</label>
                            <input type="date" class="form-control" id="dataTransacao" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarTransacaoMeta()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variáveis globais
        let token = localStorage.getItem('token');
        let graficoEvolucao = null;
        let graficoCategorias = null;
        let graficoReceitas = null;

        // Configurar headers para requisições
        const headers = {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };

        // Função para mostrar seções
        function showSection(sectionName) {
            // Esconder todas as seções
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remover classe active de todos os links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Mostrar seção selecionada
            document.getElementById(sectionName + '-section').style.display = 'block';
            
            // Adicionar classe active ao link
            event.target.classList.add('active');
            
            // Carregar dados da seção
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'contas-pagar':
                    loadContasPagar();
                    break;
                case 'contas-receber':
                    loadContasReceber();
                    break;
                case 'metas':
                    loadMetas();
                    break;
                case 'investimentos':
                    loadInvestimentos();
                    break;
                case 'relatorios':
                    loadRelatorios();
                    break;
            }
        }

        // Função para mostrar modais
        function showModal(modalId) {
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
        }

        // Função para formatar moeda
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        // Função para aplicar máscara de moeda em inputs
        function aplicarMascaraMoeda(input) {
            input.addEventListener('input', function(e) {
                let valor = e.target.value.replace(/\D/g, '');
                if (valor.length > 0) {
                    valor = (parseInt(valor) / 100).toFixed(2);
                    valor = valor.replace('.', ',');
                    valor = valor.replace(/(\d)(\d{3})(\d{3}),/g, '$1.$2.$3,');
                    valor = valor.replace(/(\d)(\d{3}),/g, '$1.$2,');
                    e.target.value = 'R$ ' + valor;
                }
            });

            input.addEventListener('blur', function(e) {
                if (e.target.value === 'R$ ') {
                    e.target.value = '';
                }
            });

            input.addEventListener('focus', function(e) {
                if (e.target.value === '') {
                    e.target.value = 'R$ ';
                }
            });
        }

        // Função para converter valor formatado para número
        function converterMoedaParaNumero(valorFormatado) {
            if (!valorFormatado) return 0;
            return parseFloat(valorFormatado.replace('R$ ', '').replace(/\./g, '').replace(',', '.')) || 0;
        }

        // Função para formatar valor para input
        function formatarValorParaInput(valor) {
            if (!valor || valor === 0) return '';
            return formatarMoeda(valor);
        }

        // Função para formatar data
        function formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR');
        }

        // Função para obter status badge
        function getStatusBadge(status) {
            const statusMap = {
                'pendente': 'warning',
                'pago': 'success',
                'vencido': 'danger',
                'cancelado': 'secondary'
            };
            return `<span class="badge bg-${statusMap[status]} status-badge">${status.toUpperCase()}</span>`;
        }

        // Carregar Dashboard
        async function loadDashboard() {
            try {
                // Obter modo selecionado
                const modo = obterModoDashboard();
                
                // Construir URL baseada no modo
                let url = '/api/financeiro/dashboard';
                if (modo === 'mensal') {
                    url += `?mes=${mesAtual}&ano=${anoAtual}&tipo=mensal`;
                } else if (modo === 'anual') {
                    url += `?ano=${anoAtual}&tipo=anual`;
                } else if (modo === 'total') {
                    url += `?tipo=total`;
                }
                
                const response = await fetch(url, { headers });
                const data = await response.json();
                
                // Atualizar labels e períodos
                atualizarLabelsDashboard(modo);
                
                // Atualizar valores
                document.getElementById('saldo-atual').textContent = formatarMoeda(data.saldo_atual);
                document.getElementById('receitas-mes').textContent = formatarMoeda(data.receitas_mes);
                document.getElementById('despesas-mes').textContent = formatarMoeda(data.despesas_mes);
                document.getElementById('total-investido').textContent = formatarMoeda(data.total_investido);
                
                // Carregar próximas contas
                const proximasContasHtml = data.proximas_contas.map(conta => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>${conta.descricao}</strong>
                            <br>
                            <small class="text-muted">Vence em ${formatarData(conta.data_vencimento)}</small>
                        </div>
                        <div class="text-end">
                            <strong>${formatarMoeda(conta.valor)}</strong>
                            <br>
                            ${getStatusBadge(conta.status)}
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('proximas-contas').innerHTML = proximasContasHtml || '<p class="text-muted">Nenhuma conta próxima</p>';
                
                // Carregar gráfico de evolução
                loadGraficoEvolucao();
                
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        // Carregar gráfico de evolução
        async function loadGraficoEvolucao() {
            try {
                const response = await fetch('/api/financeiro/graficos/mensal?meses=12', { headers });
                const data = await response.json();
                
                const ctx = document.getElementById('graficoEvolucao').getContext('2d');
                
                if (graficoEvolucao) {
                    graficoEvolucao.destroy();
                }
                
                graficoEvolucao = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(item => item.mes),
                        datasets: [{
                            label: 'Receitas',
                            data: data.map(item => item.receitas),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }, {
                            label: 'Despesas',
                            data: data.map(item => item.despesas),
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatarMoeda(value);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar gráfico de evolução:', error);
            }
        }

        // Carregar Contas a Pagar
        async function loadContasPagar() {
            try {
                const response = await fetch(`/api/financeiro/contas-pagar?mes=${mesAtual}&ano=${anoAtual}`, { headers });
                const contas = await response.json();
                
                const contasHtml = contas.map(conta => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 class="mb-1">
                                        ${conta.descricao}
                                        ${conta.is_parcelada ? 
                                            `<span class="badge bg-info ms-2">Parcela ${conta.parcela_atual}/${conta.total_parcelas}</span>` : ''
                                        }
                                    </h6>
                                    <small class="text-muted">${conta.categoria} • Vence em ${formatarData(conta.data_vencimento)}</small>
                                    ${conta.is_parcelada ? 
                                        `<small class="text-muted d-block">Valor da parcela: ${formatarMoeda(conta.valor_parcela)}</small>` : ''
                                    }
                                </div>
                                <div class="col-md-3 text-center">
                                    <h5 class="mb-0">${formatarMoeda(conta.valor)}</h5>
                                </div>
                                <div class="col-md-3 text-end">
                                    ${getStatusBadge(conta.status)}
                                    <div class="btn-group mt-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editarContaPagar(${conta.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        ${conta.is_parcelada && conta.status === 'pendente' ? 
                                            `<button class="btn btn-sm btn-outline-warning" onclick="anteciparParcela(${conta.id})" title="Antecipar Parcela">
                                                <i class="fas fa-calendar-plus"></i>
                                            </button>` : ''
                                        }
                                        ${conta.status === 'pendente' ? 
                                            `<button class="btn btn-sm btn-outline-success" onclick="marcarComoPago(${conta.id})">
                                                <i class="fas fa-check"></i>
                                            </button>` : ''
                                        }
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletarContaPagar(${conta.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('lista-contas-pagar').innerHTML = contasHtml || '<p class="text-muted">Nenhuma conta encontrada</p>';
                
            } catch (error) {
                console.error('Erro ao carregar contas a pagar:', error);
            }
        }

        // Carregar Contas a Receber
        async function loadContasReceber() {
            try {
                const response = await fetch(`/api/financeiro/contas-receber?mes=${mesAtual}&ano=${anoAtual}`, { headers });
                const contas = await response.json();
                
                const contasHtml = contas.map(conta => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 class="mb-1">${conta.descricao}</h6>
                                    <small class="text-muted">${conta.categoria} • Vence em ${formatarData(conta.data_vencimento)}</small>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h5 class="mb-0">${formatarMoeda(conta.valor)}</h5>
                                </div>
                                <div class="col-md-3 text-end">
                                    ${getStatusBadge(conta.status)}
                                    <div class="btn-group mt-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editarContaReceber(${conta.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        ${conta.status === 'pendente' ? 
                                            `<button class="btn btn-sm btn-outline-success" onclick="marcarComoRecebido(${conta.id})">
                                                <i class="fas fa-check"></i>
                                            </button>` : ''
                                        }
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletarContaReceber(${conta.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('lista-contas-receber').innerHTML = contasHtml || '<p class="text-muted">Nenhuma conta encontrada</p>';
                
            } catch (error) {
                console.error('Erro ao carregar contas a receber:', error);
            }
        }

        // Carregar Metas
        async function loadMetas() {
            try {
                const response = await fetch('/api/financeiro/metas', { headers });
                const metas = await response.json();
                
                const metasHtml = metas.map(meta => {
                    const progresso = (meta.valor_atual / meta.valor_meta) * 100;
                    const statusClass = meta.status === 'concluida' ? 'success' : 
                                      meta.status === 'pausada' ? 'warning' : 'primary';
                    
                    return `
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h5 class="card-title">${meta.titulo}</h5>
                                        <span class="badge bg-${statusClass}">${meta.status.toUpperCase()}</span>
                                    </div>
                                    <p class="card-text text-muted">${meta.descricao || 'Sem descrição'}</p>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small>Progresso</small>
                                            <small>${formatarMoeda(meta.valor_atual)} / ${formatarMoeda(meta.valor_meta)}</small>
                                        </div>
                                        <div class="progress">
                                            <div class="progress-bar bg-${statusClass}" style="width: ${Math.min(progresso, 100)}%"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            Meta: ${formatarData(meta.data_meta)}
                                        </small>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editarMeta(${meta.id})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-success" onclick="adicionarValorMeta(${meta.id})">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="verTransacoesMeta(${meta.id})">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deletarMeta(${meta.id})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('lista-metas').innerHTML = metasHtml || '<p class="text-muted">Nenhuma meta encontrada</p>';
                
            } catch (error) {
                console.error('Erro ao carregar metas:', error);
            }
        }

        // Carregar Investimentos
        async function loadInvestimentos() {
            try {
                const response = await fetch(`/api/financeiro/investimentos?mes=${mesAtual}&ano=${anoAtual}`, { headers });
                const investimentos = await response.json();
                
                const investimentosHtml = investimentos.map(inv => {
                    const rentabilidade = ((inv.valor_atual - inv.valor_investido) / inv.valor_investido) * 100;
                    const rentabilidadeClass = rentabilidade >= 0 ? 'text-success' : 'text-danger';
                    
                    return `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <h6 class="mb-1">${inv.nome}</h6>
                                        <small class="text-muted">${inv.tipo.toUpperCase()}</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <h6 class="mb-0">${formatarMoeda(inv.valor_investido)}</h6>
                                        <small class="text-muted">Investido</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <h6 class="mb-0">${formatarMoeda(inv.valor_atual)}</h6>
                                        <small class="text-muted">Atual</small>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <h6 class="mb-0 ${rentabilidadeClass}">${rentabilidade.toFixed(2)}%</h6>
                                        <small class="text-muted">Rentabilidade</small>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <span class="badge bg-${inv.ativo ? 'success' : 'secondary'}">${inv.ativo ? 'ATIVO' : 'INATIVO'}</span>
                                        <div class="btn-group mt-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editarInvestimento(${inv.id})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deletarInvestimento(${inv.id})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('lista-investimentos').innerHTML = investimentosHtml || '<p class="text-muted">Nenhum investimento encontrado</p>';
                
            } catch (error) {
                console.error('Erro ao carregar investimentos:', error);
            }
        }

        // Carregar Relatórios
        async function loadRelatorios() {
            try {
                // Carregar relatório de despesas por categoria
                const responseDespesas = await fetch('/api/financeiro/relatorios/categorias?tipo=despesas', { headers });
                const despesas = await responseDespesas.json();
                
                // Carregar relatório de receitas por categoria
                const responseReceitas = await fetch('/api/financeiro/relatorios/categorias?tipo=receitas', { headers });
                const receitas = await responseReceitas.json();
                
                // Gráfico de despesas
                const ctxDespesas = document.getElementById('graficoCategorias').getContext('2d');
                if (graficoCategorias) {
                    graficoCategorias.destroy();
                }
                
                graficoCategorias = new Chart(ctxDespesas, {
                    type: 'doughnut',
                    data: {
                        labels: despesas.map(item => item.categoria),
                        datasets: [{
                            data: despesas.map(item => item.total),
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF',
                                '#FF9F40',
                                '#FF6384'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                // Gráfico de receitas
                const ctxReceitas = document.getElementById('graficoReceitas').getContext('2d');
                if (graficoReceitas) {
                    graficoReceitas.destroy();
                }
                
                graficoReceitas = new Chart(ctxReceitas, {
                    type: 'doughnut',
                    data: {
                        labels: receitas.map(item => item.categoria),
                        datasets: [{
                            data: receitas.map(item => item.total),
                            backgroundColor: [
                                '#4BC0C0',
                                '#36A2EB',
                                '#FFCE56',
                                '#FF6384',
                                '#9966FF',
                                '#FF9F40',
                                '#4BC0C0'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Erro ao carregar relatórios:', error);
            }
        }

        // Funções de CRUD para Contas a Pagar
        async function salvarContaPagar() {
            const conta = {
                descricao: document.getElementById('descricaoPagar').value,
                valor: converterMoedaParaNumero(document.getElementById('valorPagar').value),
                data_vencimento: document.getElementById('vencimentoPagar').value,
                categoria: document.getElementById('categoriaPagar').value,
                observacoes: document.getElementById('observacoesPagar').value
            };
            
            try {
                const response = await fetch('/api/financeiro/contas-pagar', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(conta)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalContaPagar')).hide();
                    document.getElementById('formContaPagar').reset();
                    loadContasPagar();
                }
            } catch (error) {
                console.error('Erro ao salvar conta a pagar:', error);
            }
        }

        // Funções para Conta Parcelada
        function calcularValorParcela() {
            const valorTotal = converterMoedaParaNumero(document.getElementById('valorTotalParcelada').value);
            const totalParcelas = parseInt(document.getElementById('totalParcelas').value);
            
            if (valorTotal && totalParcelas) {
                const valorParcela = valorTotal / totalParcelas;
                document.getElementById('valorParcelaCalculado').value = formatarValorParaInput(valorParcela);
                gerarPreviaParcelas();
            }
        }

        function gerarPreviaParcelas() {
            const valorTotal = converterMoedaParaNumero(document.getElementById('valorTotalParcelada').value);
            const totalParcelas = parseInt(document.getElementById('totalParcelas').value);
            const dataPrimeira = document.getElementById('dataPrimeiraParcela').value;
            
            if (valorTotal && totalParcelas && dataPrimeira) {
                const valorParcela = valorTotal / totalParcelas;
                const dataInicial = new Date(dataPrimeira);
                
                let previa = '<div class="row">';
                for (let i = 0; i < Math.min(totalParcelas, 6); i++) {
                    const dataVencimento = new Date(dataInicial);
                    dataVencimento.setMonth(dataVencimento.getMonth() + i);
                    
                    previa += `
                        <div class="col-md-6 mb-2">
                            <small class="text-muted">
                                Parcela ${i + 1}: ${formatarValorParaInput(valorParcela)} - 
                                ${dataVencimento.toLocaleDateString('pt-BR')}
                            </small>
                        </div>
                    `;
                }
                
                if (totalParcelas > 6) {
                    previa += `
                        <div class="col-12">
                            <small class="text-muted">... e mais ${totalParcelas - 6} parcelas</small>
                        </div>
                    `;
                }
                
                previa += '</div>';
                document.getElementById('previaParcelas').innerHTML = previa;
            }
        }

        async function salvarContaParcelada() {
            const conta = {
                descricao: document.getElementById('descricaoParcelada').value,
                valor_total: converterMoedaParaNumero(document.getElementById('valorTotalParcelada').value),
                data_vencimento_primeira: document.getElementById('dataPrimeiraParcela').value,
                categoria: document.getElementById('categoriaParcelada').value,
                total_parcelas: parseInt(document.getElementById('totalParcelas').value),
                observacoes: document.getElementById('observacoesParcelada').value
            };
            
            try {
                const response = await fetch('/api/financeiro/contas-pagar/parcelada', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(conta)
                });
                
                if (response.ok) {
                    const parcelas = await response.json();
                    bootstrap.Modal.getInstance(document.getElementById('modalContaParcelada')).hide();
                    document.getElementById('formContaParcelada').reset();
                    document.getElementById('previaParcelas').innerHTML = '';
                    loadContasPagar();
                    alert(`Conta parcelada criada com sucesso! ${parcelas.length} parcelas foram geradas.`);
                } else {
                    const error = await response.json();
                    alert('Erro ao criar conta parcelada: ' + error.detail);
                }
            } catch (error) {
                console.error('Erro ao salvar conta parcelada:', error);
                alert('Erro ao criar conta parcelada');
            }
        }

        function verParcelas(contaId) {
            // Implementar visualização das parcelas
            window.location.href = `/financeiro/parcelas/${contaId}`;
        }

        async function anteciparParcela(parcelaId) {
            const novaData = prompt('Digite a nova data de vencimento (DD/MM/AAAA):');
            if (novaData) {
                try {
                    const [dia, mes, ano] = novaData.split('/');
                    const dataFormatada = `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
                    
                    const response = await fetch(`/api/financeiro/contas-pagar/${parcelaId}/antecipar`, {
                        method: 'PUT',
                        headers,
                        body: JSON.stringify({
                            parcela_id: parcelaId,
                            nova_data_vencimento: dataFormatada
                        })
                    });
                    
                    if (response.ok) {
                        loadContasPagar();
                        alert('Parcela antecipada com sucesso!');
                    } else {
                        alert('Erro ao antecipar parcela');
                    }
                } catch (error) {
                    console.error('Erro ao antecipar parcela:', error);
                    alert('Erro ao antecipar parcela');
                }
            }
        }

        async function marcarComoPago(contaId) {
            try {
                const response = await fetch(`/api/financeiro/contas-pagar/${contaId}/pagar`, {
                    method: 'POST',
                    headers
                });
                
                if (response.ok) {
                    loadContasPagar();
                }
            } catch (error) {
                console.error('Erro ao marcar como pago:', error);
            }
        }

        async function deletarContaPagar(contaId) {
            if (confirm('Tem certeza que deseja deletar esta conta?')) {
                try {
                    const response = await fetch(`/api/financeiro/contas-pagar/${contaId}`, {
                        method: 'DELETE',
                        headers
                    });
                    
                    if (response.ok) {
                        loadContasPagar();
                    }
                } catch (error) {
                    console.error('Erro ao deletar conta a pagar:', error);
                }
            }
        }

        // Funções de CRUD para Contas a Receber
        async function salvarContaReceber() {
            const conta = {
                descricao: document.getElementById('descricaoReceber').value,
                valor: converterMoedaParaNumero(document.getElementById('valorReceber').value),
                data_vencimento: document.getElementById('vencimentoReceber').value,
                categoria: document.getElementById('categoriaReceber').value,
                observacoes: document.getElementById('observacoesReceber').value
            };
            
            try {
                const response = await fetch('/api/financeiro/contas-receber', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(conta)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalContaReceber')).hide();
                    document.getElementById('formContaReceber').reset();
                    loadContasReceber();
                }
            } catch (error) {
                console.error('Erro ao salvar conta a receber:', error);
            }
        }

        async function marcarComoRecebido(contaId) {
            try {
                const response = await fetch(`/api/financeiro/contas-receber/${contaId}/receber`, {
                    method: 'POST',
                    headers
                });
                
                if (response.ok) {
                    loadContasReceber();
                }
            } catch (error) {
                console.error('Erro ao marcar como recebido:', error);
            }
        }

        async function deletarContaReceber(contaId) {
            if (confirm('Tem certeza que deseja deletar esta conta?')) {
                try {
                    const response = await fetch(`/api/financeiro/contas-receber/${contaId}`, {
                        method: 'DELETE',
                        headers
                    });
                    
                    if (response.ok) {
                        loadContasReceber();
                    }
                } catch (error) {
                    console.error('Erro ao deletar conta a receber:', error);
                }
            }
        }

        // Funções de CRUD para Metas
        async function salvarMeta() {
            const meta = {
                titulo: document.getElementById('tituloMeta').value,
                descricao: document.getElementById('descricaoMeta').value,
                valor_meta: converterMoedaParaNumero(document.getElementById('valorMeta').value),
                data_inicio: document.getElementById('inicioMeta').value,
                data_meta: document.getElementById('dataMeta').value,
                cor: document.getElementById('corMeta').value
            };
            
            try {
                const response = await fetch('/api/financeiro/metas', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(meta)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalMeta')).hide();
                    document.getElementById('formMeta').reset();
                    loadMetas();
                }
            } catch (error) {
                console.error('Erro ao salvar meta:', error);
            }
        }

        async function adicionarValorMeta(metaId) {
            document.getElementById('metaIdTransacao').value = metaId;
            document.getElementById('dataTransacao').value = new Date().toISOString().split('T')[0];
            showModal('modalTransacaoMeta');
        }

        async function salvarTransacaoMeta() {
            const transacao = {
                meta_id: parseInt(document.getElementById('metaIdTransacao').value),
                valor: converterMoedaParaNumero(document.getElementById('valorTransacao').value),
                descricao: document.getElementById('descricaoTransacao').value,
                data_transacao: document.getElementById('dataTransacao').value
            };
            
            try {
                const response = await fetch(`/api/financeiro/metas/${transacao.meta_id}/transacoes`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(transacao)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalTransacaoMeta')).hide();
                    document.getElementById('formTransacaoMeta').reset();
                    loadMetas();
                }
            } catch (error) {
                console.error('Erro ao salvar transação de meta:', error);
            }
        }

        async function deletarMeta(metaId) {
            if (confirm('Tem certeza que deseja deletar esta meta? Todas as transações relacionadas também serão deletadas.')) {
                try {
                    const response = await fetch(`/api/financeiro/metas/${metaId}`, {
                        method: 'DELETE',
                        headers
                    });
                    
                    if (response.ok) {
                        loadMetas();
                    }
                } catch (error) {
                    console.error('Erro ao deletar meta:', error);
                }
            }
        }

        // Funções de CRUD para Investimentos
        async function salvarInvestimento() {
            const investimento = {
                nome: document.getElementById('nomeInvestimento').value,
                tipo: document.getElementById('tipoInvestimento').value,
                valor_investido: converterMoedaParaNumero(document.getElementById('valorInvestido').value),
                valor_atual: converterMoedaParaNumero(document.getElementById('valorAtual').value),
                data_investimento: document.getElementById('dataInvestimento').value,
                rentabilidade_anual: parseFloat(document.getElementById('rentabilidadeAnual').value) || null,
                observacoes: document.getElementById('observacoesInvestimento').value
            };
            
            try {
                const response = await fetch('/api/financeiro/investimentos', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(investimento)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalInvestimento')).hide();
                    document.getElementById('formInvestimento').reset();
                    loadInvestimentos();
                }
            } catch (error) {
                console.error('Erro ao salvar investimento:', error);
            }
        }

        async function deletarInvestimento(investimentoId) {
            if (confirm('Tem certeza que deseja deletar este investimento?')) {
                try {
                    const response = await fetch(`/api/financeiro/investimentos/${investimentoId}`, {
                        method: 'DELETE',
                        headers
                    });
                    
                    if (response.ok) {
                        loadInvestimentos();
                    }
                } catch (error) {
                    console.error('Erro ao deletar investimento:', error);
                }
            }
        }

        // Funções de filtro
        function filtrarContasPagar() {
            const status = document.getElementById('filtro-status-pagar').value;
            const categoria = document.getElementById('filtro-categoria-pagar').value;
            const mes = document.getElementById('filtro-mes-pagar').value;
            
            // Implementar filtros aqui
            loadContasPagar();
        }

        function filtrarContasReceber() {
            const status = document.getElementById('filtro-status-receber').value;
            const categoria = document.getElementById('filtro-categoria-receber').value;
            const mes = document.getElementById('filtro-mes-receber').value;
            
            // Implementar filtros aqui
            loadContasReceber();
        }

        function filtrarInvestimentos() {
            const tipo = document.getElementById('filtro-tipo-investimento').value;
            const ativo = document.getElementById('filtro-status-investimento').value;
            
            // Implementar filtros aqui
            loadInvestimentos();
        }

        // ==================== FUNÇÕES DE EDIÇÃO ====================
        
        // Editar Conta a Pagar
        async function editarContaPagar(contaId) {
            try {
                const response = await fetch(`/api/financeiro/contas-pagar/${contaId}`, { headers });
                const conta = await response.json();
                
                // Preencher modal
                document.getElementById('editarContaPagarId').value = conta.id;
                document.getElementById('editarDescricaoPagar').value = conta.descricao;
                document.getElementById('editarValorPagar').value = formatarValorParaInput(conta.valor);
                document.getElementById('editarVencimentoPagar').value = conta.data_vencimento;
                document.getElementById('editarCategoriaPagar').value = conta.categoria;
                document.getElementById('editarStatusPagar').value = conta.status;
                document.getElementById('editarObservacoesPagar').value = conta.observacoes || '';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalEditarContaPagar'));
                modal.show();
            } catch (error) {
                console.error('Erro ao carregar conta a pagar:', error);
                alert('Erro ao carregar dados da conta');
            }
        }
        
        async function salvarEdicaoContaPagar() {
            const contaId = document.getElementById('editarContaPagarId').value;
            const conta = {
                descricao: document.getElementById('editarDescricaoPagar').value,
                valor: converterMoedaParaNumero(document.getElementById('editarValorPagar').value),
                data_vencimento: document.getElementById('editarVencimentoPagar').value,
                categoria: document.getElementById('editarCategoriaPagar').value,
                status: document.getElementById('editarStatusPagar').value,
                observacoes: document.getElementById('editarObservacoesPagar').value
            };
            
            try {
                const response = await fetch(`/api/financeiro/contas-pagar/${contaId}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(conta)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarContaPagar')).hide();
                    loadContasPagar();
                    alert('Conta atualizada com sucesso!');
                } else {
                    const error = await response.json();
                    alert('Erro ao atualizar conta: ' + error.detail);
                }
            } catch (error) {
                console.error('Erro ao atualizar conta a pagar:', error);
                alert('Erro de conexão: ' + error.message);
            }
        }
        
        // Editar Conta a Receber
        async function editarContaReceber(contaId) {
            try {
                const response = await fetch(`/api/financeiro/contas-receber/${contaId}`, { headers });
                const conta = await response.json();
                
                // Preencher modal
                document.getElementById('editarContaReceberId').value = conta.id;
                document.getElementById('editarDescricaoReceber').value = conta.descricao;
                document.getElementById('editarValorReceber').value = formatarValorParaInput(conta.valor);
                document.getElementById('editarVencimentoReceber').value = conta.data_vencimento;
                document.getElementById('editarCategoriaReceber').value = conta.categoria;
                document.getElementById('editarStatusReceber').value = conta.status;
                document.getElementById('editarObservacoesReceber').value = conta.observacoes || '';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalEditarContaReceber'));
                modal.show();
            } catch (error) {
                console.error('Erro ao carregar conta a receber:', error);
                alert('Erro ao carregar dados da conta');
            }
        }
        
        async function salvarEdicaoContaReceber() {
            const contaId = document.getElementById('editarContaReceberId').value;
            const conta = {
                descricao: document.getElementById('editarDescricaoReceber').value,
                valor: converterMoedaParaNumero(document.getElementById('editarValorReceber').value),
                data_vencimento: document.getElementById('editarVencimentoReceber').value,
                categoria: document.getElementById('editarCategoriaReceber').value,
                status: document.getElementById('editarStatusReceber').value,
                observacoes: document.getElementById('editarObservacoesReceber').value
            };
            
            try {
                const response = await fetch(`/api/financeiro/contas-receber/${contaId}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(conta)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarContaReceber')).hide();
                    loadContasReceber();
                    alert('Conta atualizada com sucesso!');
                } else {
                    const error = await response.json();
                    alert('Erro ao atualizar conta: ' + error.detail);
                }
            } catch (error) {
                console.error('Erro ao atualizar conta a receber:', error);
                alert('Erro de conexão: ' + error.message);
            }
        }
        
        // Editar Meta
        async function editarMeta(metaId) {
            try {
                const response = await fetch(`/api/financeiro/metas/${metaId}`, { headers });
                const meta = await response.json();
                
                // Preencher modal
                document.getElementById('editarMetaId').value = meta.id;
                document.getElementById('editarTituloMeta').value = meta.titulo;
                document.getElementById('editarDescricaoMeta').value = meta.descricao || '';
                document.getElementById('editarValorMeta').value = formatarValorParaInput(meta.valor_meta);
                document.getElementById('editarInicioMeta').value = meta.data_inicio;
                document.getElementById('editarDataMeta').value = meta.data_meta;
                document.getElementById('editarStatusMeta').value = meta.status;
                document.getElementById('editarCorMeta').value = meta.cor || '#3B82F6';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalEditarMeta'));
                modal.show();
            } catch (error) {
                console.error('Erro ao carregar meta:', error);
                alert('Erro ao carregar dados da meta');
            }
        }
        
        async function salvarEdicaoMeta() {
            const metaId = document.getElementById('editarMetaId').value;
            const meta = {
                titulo: document.getElementById('editarTituloMeta').value,
                descricao: document.getElementById('editarDescricaoMeta').value,
                valor_meta: converterMoedaParaNumero(document.getElementById('editarValorMeta').value),
                data_inicio: document.getElementById('editarInicioMeta').value,
                data_meta: document.getElementById('editarDataMeta').value,
                status: document.getElementById('editarStatusMeta').value,
                cor: document.getElementById('editarCorMeta').value
            };
            
            try {
                const response = await fetch(`/api/financeiro/metas/${metaId}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(meta)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarMeta')).hide();
                    loadMetas();
                    alert('Meta atualizada com sucesso!');
                } else {
                    const error = await response.json();
                    alert('Erro ao atualizar meta: ' + error.detail);
                }
            } catch (error) {
                console.error('Erro ao atualizar meta:', error);
                alert('Erro de conexão: ' + error.message);
            }
        }
        
        // Editar Investimento
        async function editarInvestimento(investimentoId) {
            try {
                const response = await fetch(`/api/financeiro/investimentos/${investimentoId}`, { headers });
                const investimento = await response.json();
                
                // Preencher modal
                document.getElementById('editarInvestimentoId').value = investimento.id;
                document.getElementById('editarNomeInvestimento').value = investimento.nome;
                document.getElementById('editarTipoInvestimento').value = investimento.tipo;
                document.getElementById('editarValorInvestido').value = formatarValorParaInput(investimento.valor_investido);
                document.getElementById('editarValorAtual').value = formatarValorParaInput(investimento.valor_atual);
                document.getElementById('editarDataInvestimento').value = investimento.data_investimento;
                document.getElementById('editarRentabilidadeAnual').value = investimento.rentabilidade_anual || '';
                document.getElementById('editarAtivoInvestimento').value = investimento.ativo.toString();
                document.getElementById('editarObservacoesInvestimento').value = investimento.observacoes || '';
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('modalEditarInvestimento'));
                modal.show();
            } catch (error) {
                console.error('Erro ao carregar investimento:', error);
                alert('Erro ao carregar dados do investimento');
            }
        }
        
        async function salvarEdicaoInvestimento() {
            const investimentoId = document.getElementById('editarInvestimentoId').value;
            const investimento = {
                nome: document.getElementById('editarNomeInvestimento').value,
                tipo: document.getElementById('editarTipoInvestimento').value,
                valor_investido: converterMoedaParaNumero(document.getElementById('editarValorInvestido').value),
                valor_atual: converterMoedaParaNumero(document.getElementById('editarValorAtual').value),
                data_investimento: document.getElementById('editarDataInvestimento').value,
                rentabilidade_anual: parseFloat(document.getElementById('editarRentabilidadeAnual').value) || null,
                ativo: document.getElementById('editarAtivoInvestimento').value === 'true',
                observacoes: document.getElementById('editarObservacoesInvestimento').value
            };
            
            try {
                const response = await fetch(`/api/financeiro/investimentos/${investimentoId}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(investimento)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('modalEditarInvestimento')).hide();
                    loadInvestimentos();
                    alert('Investimento atualizado com sucesso!');
                } else {
                    const error = await response.json();
                    alert('Erro ao atualizar investimento: ' + error.detail);
                }
            } catch (error) {
                console.error('Erro ao atualizar investimento:', error);
                alert('Erro de conexão: ' + error.message);
            }
        }

        // Aplicar máscaras de moeda em todos os inputs de valor
        function aplicarMascarasMoeda() {
            // Campos de criação
            const camposValor = [
                'valorPagar', 'valorReceber', 'valorMeta', 'valorInvestido', 'valorAtual', 'valorTransacao',
                'editarValorPagar', 'editarValorReceber', 'editarValorMeta', 'editarValorInvestido', 'editarValorAtual'
            ];
            
            camposValor.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    aplicarMascaraMoeda(input);
                }
            });
        }

        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se há token
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            // Aplicar máscaras de moeda
            aplicarMascarasMoeda();
            
            // Event listeners para conta parcelada
            document.getElementById('valorTotalParcelada').addEventListener('input', calcularValorParcela);
            document.getElementById('totalParcelas').addEventListener('input', calcularValorParcela);
            document.getElementById('dataPrimeiraParcela').addEventListener('change', gerarPreviaParcelas);
            
            // Carregar dashboard inicial
            loadDashboard();
        });

        // ==================== FUNCIONALIDADES MENSAIS ====================
        
        // Variáveis para controle mensal
        let mesAtual = new Date().getMonth() + 1;
        let anoAtual = new Date().getFullYear();
        
        // Função para alterar mês
        function alterarMes(direcao) {
            mesAtual += direcao;
            
            if (mesAtual > 12) {
                mesAtual = 1;
                anoAtual++;
            } else if (mesAtual < 1) {
                mesAtual = 12;
                anoAtual--;
            }
            
            atualizarDisplayMes();
            recarregarDadosMensais();
        }
        
        // Atualizar display do mês
        function atualizarDisplayMes() {
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('mes-nome').textContent = `${meses[mesAtual-1]} ${anoAtual}`;
        }
        
        // Recarregar todos os dados mensais
        function recarregarDadosMensais() {
            // Recarregar dashboard com dados do mês selecionado
            loadDashboard();
            
            // Recarregar contas a pagar do mês
            loadContasPagar();
            
            // Recarregar contas a receber do mês
            loadContasReceber();
            
            // Recarregar metas mensais
            loadMetasMensais();
            
            // Recarregar investimentos do mês
            loadInvestimentos();
        }
        
        // Carregar metas mensais
        async function loadMetasMensais() {
            try {
                const response = await fetch(`/api/financeiro/metas-mensais?mes=${mesAtual}&ano=${anoAtual}`, { headers });
                const metas = await response.json();
                
                // Atualizar status das metas
                if (metas.length > 0) {
                    const meta = metas[0];
                    atualizarStatusMetasMensais(meta);
                } else {
                    limparStatusMetasMensais();
                }
                
                // Atualizar lista de metas
                atualizarListaMetasMensais(metas);
                
            } catch (error) {
                console.error('Erro ao carregar metas mensais:', error);
            }
        }
        
        // Atualizar status das metas mensais
        function atualizarStatusMetasMensais(meta) {
            document.getElementById('percentual-receita-mensal').textContent = `${meta.percentual_receita}%`;
            document.getElementById('barra-receita-mensal').style.width = `${Math.min(meta.percentual_receita, 100)}%`;
            document.getElementById('valor-receita-mensal').textContent = 
                `${formatarMoeda(meta.receita_realizada)} / ${formatarMoeda(meta.meta_receita)}`;
            
            document.getElementById('percentual-despesa-mensal').textContent = `${meta.percentual_despesa}%`;
            document.getElementById('barra-despesa-mensal').style.width = `${Math.min(meta.percentual_despesa, 100)}%`;
            document.getElementById('valor-despesa-mensal').textContent = 
                `${formatarMoeda(meta.despesa_realizada)} / ${formatarMoeda(meta.meta_despesa)}`;
            
            document.getElementById('percentual-investimento-mensal').textContent = `${meta.percentual_investimento}%`;
            document.getElementById('barra-investimento-mensal').style.width = `${Math.min(meta.percentual_investimento, 100)}%`;
            document.getElementById('valor-investimento-mensal').textContent = 
                `${formatarMoeda(meta.investimento_realizado)} / ${formatarMoeda(meta.meta_investimento)}`;
            
            document.getElementById('percentual-poupanca-mensal').textContent = `${meta.percentual_poupanca}%`;
            document.getElementById('barra-poupanca-mensal').style.width = `${Math.min(meta.percentual_poupanca, 100)}%`;
            document.getElementById('valor-poupanca-mensal').textContent = 
                `${formatarMoeda(meta.poupanca_realizada)} / ${formatarMoeda(meta.meta_poupanca)}`;
            
            // Atualizar status geral
            const statusClasses = {
                'excelente': 'bg-success',
                'bom': 'bg-primary',
                'regular': 'bg-warning',
                'ruim': 'bg-danger'
            };
            const statusElement = document.getElementById('status-geral-mensal');
            statusElement.textContent = `Status: ${meta.status_geral.charAt(0).toUpperCase() + meta.status_geral.slice(1)}`;
            statusElement.className = `badge ${statusClasses[meta.status_geral] || 'bg-secondary'}`;
        }
        
        // Limpar status das metas mensais
        function limparStatusMetasMensais() {
            document.getElementById('percentual-receita-mensal').textContent = '0%';
            document.getElementById('barra-receita-mensal').style.width = '0%';
            document.getElementById('valor-receita-mensal').textContent = 'R$ 0,00 / R$ 0,00';
            
            document.getElementById('percentual-despesa-mensal').textContent = '0%';
            document.getElementById('barra-despesa-mensal').style.width = '0%';
            document.getElementById('valor-despesa-mensal').textContent = 'R$ 0,00 / R$ 0,00';
            
            document.getElementById('percentual-investimento-mensal').textContent = '0%';
            document.getElementById('barra-investimento-mensal').style.width = '0%';
            document.getElementById('valor-investimento-mensal').textContent = 'R$ 0,00 / R$ 0,00';
            
            document.getElementById('percentual-poupanca-mensal').textContent = '0%';
            document.getElementById('barra-poupanca-mensal').style.width = '0%';
            document.getElementById('valor-poupanca-mensal').textContent = 'R$ 0,00 / R$ 0,00';
            
            document.getElementById('status-geral-mensal').textContent = 'Status: Sem metas';
            document.getElementById('status-geral-mensal').className = 'badge bg-secondary';
        }
        
        // Atualizar lista de metas mensais
        function atualizarListaMetasMensais(metas) {
            const container = document.getElementById('lista-metas-mensais');
            
            if (metas.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nenhuma meta mensal encontrada para ${mesAtual}/${anoAtual}</p>
                        <button class="btn btn-primary" onclick="criarMetaMensal()">
                            <i class="fas fa-plus me-2"></i>Criar Meta Mensal
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            metas.forEach(meta => {
                const statusClasses = {
                    'excelente': 'success',
                    'bom': 'primary',
                    'regular': 'warning',
                    'ruim': 'danger'
                };
                
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-1">Meta de ${mesAtual}/${anoAtual}</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Receitas: ${meta.percentual_receita}%</small>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Despesas: ${meta.percentual_despesa}%</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge bg-${statusClasses[meta.status_geral] || 'secondary'}">${meta.status_geral}</span>
                                    <div class="btn-group mt-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editarMetaMensal(${meta.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletarMetaMensal(${meta.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Criar meta mensal
        function criarMetaMensal() {
            // Implementar modal para criar meta mensal
            alert('Funcionalidade de criar meta mensal será implementada');
        }
        
        // Editar meta mensal
        function editarMetaMensal(metaId) {
            // Implementar edição de meta mensal
            alert('Funcionalidade de editar meta mensal será implementada');
        }
        
        // Deletar meta mensal
        async function deletarMetaMensal(metaId) {
            if (confirm('Tem certeza que deseja deletar esta meta mensal?')) {
                try {
                    const response = await fetch(`/api/financeiro/metas-mensais/${metaId}`, {
                        method: 'DELETE',
                        headers
                    });
                    
                    if (response.ok) {
                        loadMetasMensais();
                        alert('Meta mensal deletada com sucesso!');
                    } else {
                        alert('Erro ao deletar meta mensal');
                    }
                } catch (error) {
                    console.error('Erro ao deletar meta mensal:', error);
                    alert('Erro de conexão');
                }
            }
        }
        
        // Modificar função showSection para incluir metas-mensais
        function showSection(section) {
            // Esconder todas as seções
            document.querySelectorAll('.content-section').forEach(el => {
                el.style.display = 'none';
            });
            
            // Remover classe active de todos os links
            document.querySelectorAll('.nav-link').forEach(el => {
                el.classList.remove('active');
            });
            
            // Mostrar seção selecionada
            const targetSection = document.getElementById(section + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Adicionar classe active ao link
            event.target.classList.add('active');
            
            // Carregar dados específicos da seção
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'contas-pagar':
                    loadContasPagar();
                    break;
                case 'contas-receber':
                    loadContasReceber();
                    break;
                case 'metas':
                    loadMetas();
                    break;
                case 'metas-mensais':
                    loadMetasMensais();
                    break;
                case 'investimentos':
                    loadInvestimentos();
                    break;
                case 'relatorios':
                    loadRelatorios();
                    break;
            }
        }
        
        // ==================== FUNCIONALIDADES DE DASHBOARD ====================
        
        // Obter modo do dashboard selecionado
        function obterModoDashboard() {
            const modoSelecionado = document.querySelector('input[name="dashboard-mode"]:checked');
            return modoSelecionado ? modoSelecionado.value : 'mensal';
        }
        
        // Atualizar labels do dashboard baseado no modo
        function atualizarLabelsDashboard(modo) {
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            if (modo === 'mensal') {
                document.getElementById('saldo-label').textContent = 'Saldo do Mês';
                document.getElementById('receitas-label').textContent = 'Receitas do Mês';
                document.getElementById('despesas-label').textContent = 'Despesas do Mês';
                document.getElementById('investimentos-label').textContent = 'Investimentos do Mês';
                
                document.getElementById('saldo-periodo').textContent = `${meses[mesAtual-1]} ${anoAtual}`;
                document.getElementById('receitas-periodo').textContent = `${meses[mesAtual-1]} ${anoAtual}`;
                document.getElementById('despesas-periodo').textContent = `${meses[mesAtual-1]} ${anoAtual}`;
                document.getElementById('investimentos-periodo').textContent = `${meses[mesAtual-1]} ${anoAtual}`;
                
            } else if (modo === 'anual') {
                document.getElementById('saldo-label').textContent = 'Saldo do Ano';
                document.getElementById('receitas-label').textContent = 'Receitas do Ano';
                document.getElementById('despesas-label').textContent = 'Despesas do Ano';
                document.getElementById('investimentos-label').textContent = 'Investimentos do Ano';
                
                document.getElementById('saldo-periodo').textContent = `Ano ${anoAtual}`;
                document.getElementById('receitas-periodo').textContent = `Ano ${anoAtual}`;
                document.getElementById('despesas-periodo').textContent = `Ano ${anoAtual}`;
                document.getElementById('investimentos-periodo').textContent = `Ano ${anoAtual}`;
                
            } else if (modo === 'total') {
                document.getElementById('saldo-label').textContent = 'Saldo Total';
                document.getElementById('receitas-label').textContent = 'Receitas Totais';
                document.getElementById('despesas-label').textContent = 'Despesas Totais';
                document.getElementById('investimentos-label').textContent = 'Investimentos Totais';
                
                document.getElementById('saldo-periodo').textContent = 'Todos os períodos';
                document.getElementById('receitas-periodo').textContent = 'Todos os períodos';
                document.getElementById('despesas-periodo').textContent = 'Todos os períodos';
                document.getElementById('investimentos-periodo').textContent = 'Todos os períodos';
            }
        }
        
        // Adicionar event listeners para mudança de modo
        function configurarEventListenersDashboard() {
            // Event listeners para mudança de modo
            document.querySelectorAll('input[name="dashboard-mode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    loadDashboard();
                });
            });
        }
        
        // Inicializar display do mês
        atualizarDisplayMes();
        
        // Configurar event listeners do dashboard
        configurarEventListenersDashboard();
    </script>
</body>
</html>

