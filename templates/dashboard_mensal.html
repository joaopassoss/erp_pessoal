{% extends "base.html" %}

{% block title %}Dashboard Mensal - ERP Pessoal{% endblock %}
{% block page_title %}Dashboard Mensal{% endblock %}

{% block breadcrumb %}
<li><i data-lucide="chevron-right" class="w-3 h-3"></i></li>
<li><a href="/financeiro" class="hover:text-white">Financeiro</a></li>
<li><i data-lucide="chevron-right" class="w-3 h-3"></i></li>
<li class="text-white font-medium">Dashboard Mensal</li>
{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Dashboard Mensal</h2>
    <div class="flex gap-2">
        <button onclick="carregarMesAnterior()" class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg transition text-sm">
            <i data-lucide="chevron-left" class="w-4 h-4 inline"></i> Mês Anterior
        </button>
        <span class="px-4 py-2 bg-tce-main text-white rounded-lg text-sm font-semibold" id="mes-atual">Dezembro 2024</span>
        <button onclick="carregarProximoMes()" class="px-4 py-2 border border-gray-300 hover:bg-gray-50 rounded-lg transition text-sm">
            Próximo Mês <i data-lucide="chevron-right" class="w-4 h-4 inline"></i>
        </button>
    </div>
</div>

<!-- Resumo Mensal -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Receitas</p>
                <p class="text-2xl font-bold text-gray-800" id="total-receitas">R$ 0,00</p>
            </div>
            <div class="w-12 h-12 bg-green-50 text-green-600 rounded-lg flex items-center justify-center">
                <i data-lucide="trending-up" class="w-6 h-6"></i>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Despesas</p>
                <p class="text-2xl font-bold text-gray-800" id="total-despesas">R$ 0,00</p>
            </div>
            <div class="w-12 h-12 bg-red-50 text-red-600 rounded-lg flex items-center justify-center">
                <i data-lucide="trending-down" class="w-6 h-6"></i>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Saldo Mensal</p>
                <p class="text-2xl font-bold text-gray-800" id="saldo-mensal">R$ 0,00</p>
            </div>
            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center">
                <i data-lucide="scale" class="w-6 h-6"></i>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Investimentos</p>
                <p class="text-2xl font-bold text-gray-800" id="total-investimentos">R$ 0,00</p>
            </div>
            <div class="w-12 h-12 bg-yellow-50 text-yellow-600 rounded-lg flex items-center justify-center">
                <i data-lucide="chart-line" class="w-6 h-6"></i>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos e Análises -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-4 bg-emerald-50 border-b border-emerald-100">
                <h3 class="font-bold text-emerald-800 flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-4 h-4"></i> Evolução Financeira
                </h3>
            </div>
            <div class="p-6">
                <canvas id="grafico-evolucao" height="200"></canvas>
            </div>
        </div>
    </div>

    <div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-4 bg-emerald-50 border-b border-emerald-100">
                <h3 class="font-bold text-emerald-800 flex items-center gap-2">
                    <i data-lucide="target" class="w-4 h-4"></i> Status das Metas
                </h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-gray-600">Receitas</span>
                        <span class="text-sm font-bold text-gray-800" id="percentual-receita">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" id="barra-receita" style="width: 0%"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-gray-600">Despesas</span>
                        <span class="text-sm font-bold text-gray-800" id="percentual-despesa">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-red-500 h-2 rounded-full" id="barra-despesa" style="width: 0%"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-gray-600">Investimentos</span>
                        <span class="text-sm font-bold text-gray-800" id="percentual-investimento">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" id="barra-investimento" style="width: 0%"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-gray-600">Poupança</span>
                        <span class="text-sm font-bold text-gray-800" id="percentual-poupanca">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-500 h-2 rounded-full" id="barra-poupanca" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Análise por Categorias -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-4 bg-emerald-50 border-b border-emerald-100">
            <h3 class="font-bold text-emerald-800 flex items-center gap-2">
                <i data-lucide="pie-chart" class="w-4 h-4"></i> Receitas por Categoria
            </h3>
        </div>
        <div class="p-6">
            <canvas id="grafico-receitas" height="200"></canvas>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-4 bg-emerald-50 border-b border-emerald-100">
            <h3 class="font-bold text-emerald-800 flex items-center gap-2">
                <i data-lucide="pie-chart" class="w-4 h-4"></i> Despesas por Categoria
            </h3>
        </div>
        <div class="p-6">
            <canvas id="grafico-despesas" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Alertas e Notificações -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6">
    <div class="p-4 bg-emerald-50 border-b border-emerald-100">
        <h3 class="font-bold text-emerald-800 flex items-center gap-2">
            <i data-lucide="bell" class="w-4 h-4"></i> Alertas e Notificações
        </h3>
    </div>
    <div class="p-6">
        <div id="alertas-container">
            <!-- Alertas serão carregados dinamicamente -->
        </div>
    </div>
</div>

<!-- Próximos Vencimentos e Metas -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-4 bg-emerald-50 border-b border-emerald-100">
            <h3 class="font-bold text-emerald-800 flex items-center gap-2">
                <i data-lucide="calendar" class="w-4 h-4"></i> Próximos Vencimentos
            </h3>
        </div>
        <div class="p-6">
            <div id="proximos-vencimentos">
                <!-- Vencimentos serão carregados dinamicamente -->
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="p-4 bg-emerald-50 border-b border-emerald-100">
            <h3 class="font-bold text-emerald-800 flex items-center gap-2">
                <i data-lucide="target" class="w-4 h-4"></i> Metas Próximas
            </h3>
        </div>
        <div class="p-6">
            <div id="metas-proximas">
                <!-- Metas serão carregadas dinamicamente -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    lucide.createIcons();
    
    let mesAtual = new Date().getMonth() + 1;
    let anoAtual = new Date().getFullYear();

    // Carregar dados do dashboard mensal
    async function carregarDashboardMensal(mes = mesAtual, ano = anoAtual) {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/financeiro/dashboard-mensal?mes=${mes}&ano=${ano}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            
            // Atualizar resumo mensal
            document.getElementById('total-receitas').textContent = formatarMoeda(data.resumo_mensal.total_receitas);
            document.getElementById('total-despesas').textContent = formatarMoeda(data.resumo_mensal.total_despesas);
            document.getElementById('saldo-mensal').textContent = formatarMoeda(data.resumo_mensal.saldo_mensal);
            document.getElementById('total-investimentos').textContent = formatarMoeda(data.resumo_mensal.total_investido);
            
            // Atualizar título do mês
            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('mes-atual').textContent = `${meses[mes-1]} ${ano}`;
            
            // Atualizar status das metas
            if (data.metas_mensais) {
                atualizarStatusMetas(data.metas_mensais);
            }
            
            // Atualizar gráficos
            atualizarGraficoReceitas(data.resumo_mensal.receitas_por_categoria);
            atualizarGraficoDespesas(data.resumo_mensal.despesas_por_categoria);
            
            // Atualizar alertas
            atualizarAlertas(data.alertas);
            
            // Atualizar próximos vencimentos
            atualizarProximosVencimentos(data.proximos_vencimentos);
            
            // Atualizar metas próximas
            atualizarMetasProximas(data.metas_proximas);
            
        } catch (error) {
            console.error('Erro ao carregar dashboard mensal:', error);
            mostrarAlerta('Erro ao carregar dados do dashboard', 'danger');
        }
    }

    function atualizarStatusMetas(metas) {
        document.getElementById('percentual-receita').textContent = `${metas.percentual_receita}%`;
        document.getElementById('barra-receita').style.width = `${Math.min(metas.percentual_receita, 100)}%`;
        
        document.getElementById('percentual-despesa').textContent = `${metas.percentual_despesa}%`;
        document.getElementById('barra-despesa').style.width = `${Math.min(metas.percentual_despesa, 100)}%`;
        
        document.getElementById('percentual-investimento').textContent = `${metas.percentual_investimento}%`;
        document.getElementById('barra-investimento').style.width = `${Math.min(metas.percentual_investimento, 100)}%`;
        
        document.getElementById('percentual-poupanca').textContent = `${metas.percentual_poupanca}%`;
        document.getElementById('barra-poupanca').style.width = `${Math.min(metas.percentual_poupanca, 100)}%`;
    }

    function atualizarGraficoReceitas(dados) {
        const ctx = document.getElementById('grafico-receitas').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: dados.map(item => item.categoria),
                datasets: [{
                    data: dados.map(item => item.total),
                    backgroundColor: [
                        '#10b981', '#3b82f6', '#f59e0b', '#8b5cf6',
                        '#ec4899', '#14b8a6', '#f97316'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function atualizarGraficoDespesas(dados) {
        const ctx = document.getElementById('grafico-despesas').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: dados.map(item => item.categoria),
                datasets: [{
                    data: dados.map(item => item.total),
                    backgroundColor: [
                        '#ef4444', '#3b82f6', '#f59e0b', '#8b5cf6',
                        '#ec4899', '#14b8a6', '#f97316'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function atualizarAlertas(alertas) {
        const container = document.getElementById('alertas-container');
        container.innerHTML = '';
        
        if (alertas.alertas_criticos && alertas.alertas_criticos.length > 0) {
            alertas.alertas_criticos.forEach(alerta => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-red-50 border border-red-200 rounded-lg mb-2 text-red-700';
                div.innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4 inline mr-2"></i> ${alerta}`;
                container.appendChild(div);
            });
        }
        
        if (alertas.contas_vencidas && alertas.contas_vencidas.length > 0) {
            const div = document.createElement('div');
            div.className = 'p-3 bg-yellow-50 border border-yellow-200 rounded-lg mb-2 text-yellow-700';
            div.innerHTML = `<i data-lucide="clock" class="w-4 h-4 inline mr-2"></i> ${alertas.contas_vencidas.length} contas vencidas`;
            container.appendChild(div);
        }
        
        if (alertas.metas_atrasadas && alertas.metas_atrasadas.length > 0) {
            const div = document.createElement('div');
            div.className = 'p-3 bg-blue-50 border border-blue-200 rounded-lg mb-2 text-blue-700';
            div.innerHTML = `<i data-lucide="target" class="w-4 h-4 inline mr-2"></i> ${alertas.metas_atrasadas.length} metas atrasadas`;
            container.appendChild(div);
        }
        
        if ((!alertas.alertas_criticos || alertas.alertas_criticos.length === 0) && 
            (!alertas.contas_vencidas || alertas.contas_vencidas.length === 0) && 
            (!alertas.metas_atrasadas || alertas.metas_atrasadas.length === 0)) {
            const div = document.createElement('div');
            div.className = 'p-3 bg-green-50 border border-green-200 rounded-lg text-green-700';
            div.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i> Nenhum alerta crítico encontrado!';
            container.appendChild(div);
        }
        
        lucide.createIcons();
    }

    function atualizarProximosVencimentos(vencimentos) {
        const container = document.getElementById('proximos-vencimentos');
        container.innerHTML = '';
        
        if (!vencimentos || vencimentos.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Nenhum vencimento próximo</p>';
            return;
        }
        
        vencimentos.forEach(vencimento => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center mb-2 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition';
            div.innerHTML = `
                <div>
                    <strong class="text-gray-800">${vencimento.descricao}</strong><br>
                    <small class="text-gray-500">${formatarData(vencimento.data_vencimento)}</small>
                </div>
                <div class="text-right">
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">${formatarMoeda(vencimento.valor)}</span>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function atualizarMetasProximas(metas) {
        const container = document.getElementById('metas-proximas');
        container.innerHTML = '';
        
        if (!metas || metas.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Nenhuma meta próxima</p>';
            return;
        }
        
        metas.forEach(meta => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center mb-2 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition';
            const percentual = (meta.valor_atual / meta.valor_meta * 100).toFixed(1);
            div.innerHTML = `
                <div>
                    <strong class="text-gray-800">${meta.titulo}</strong><br>
                    <small class="text-gray-500">${formatarData(meta.data_meta)}</small>
                </div>
                <div class="text-right">
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">${percentual}%</span><br>
                    <small class="text-gray-500">${formatarMoeda(meta.valor_atual)} / ${formatarMoeda(meta.valor_meta)}</small>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function carregarMesAnterior() {
        if (mesAtual === 1) {
            mesAtual = 12;
            anoAtual--;
        } else {
            mesAtual--;
        }
        carregarDashboardMensal(mesAtual, anoAtual);
    }

    function carregarProximoMes() {
        if (mesAtual === 12) {
            mesAtual = 1;
            anoAtual++;
        } else {
            mesAtual++;
        }
        carregarDashboardMensal(mesAtual, anoAtual);
    }

    function formatarMoeda(valor) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(valor || 0);
    }

    function formatarData(data) {
        return new Date(data).toLocaleDateString('pt-BR');
    }

    function mostrarAlerta(mensagem, tipo = 'info') {
        const alerta = document.createElement('div');
        alerta.className = `p-4 bg-${tipo === 'danger' ? 'red' : 'blue'}-50 border border-${tipo === 'danger' ? 'red' : 'blue'}-200 rounded-lg mb-4`;
        alerta.textContent = mensagem;
        document.body.insertBefore(alerta, document.body.firstChild);
        
        setTimeout(() => {
            alerta.remove();
        }, 5000);
    }

    // Carregar dashboard ao inicializar
    document.addEventListener('DOMContentLoaded', function() {
        carregarDashboardMensal();
        lucide.createIcons();
    });
</script>
{% endblock %}
